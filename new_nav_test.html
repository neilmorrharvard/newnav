<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>New Nav Test</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        color: #111;
      }
      header {
        border-bottom: 1px solid #e9ecef;
        background: #fff;
      }
      .page-shell {
        max-width: 990px;
        margin: 0 auto;
        padding: 16px 10px;
      }
      main {
        padding: 20px 0 60px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="page-shell">
        <strong>New Nav Test Page</strong>
      </div>
    </header>

    <main class="page-shell">
      <p>This is a standalone test page for the new nav script.</p>
      <p>Resize the window to see desktop and mobile behavior.</p>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        'use strict';

        const routes = {
            communities: {
                regina: "https://staging-www2.villagemedia.ca/regina-today",
                saskatoon: "https://staging-www2.villagemedia.ca/saskatoon-today",
                estevan: "https://staging-www2.villagemedia.ca/southeast/estevanmercury",
                yorkton: "https://staging-www2.villagemedia.ca/central/yorktonthisweek",
                kamsack: "https://staging-www2.villagemedia.ca/central/kamsacktimes",
                all: "https://staging-www2.villagemedia.ca/" 
            },
            categories: {
                sports: "https://staging-www2.villagemedia.ca/sports",
                agriculture: "https://staging-www2.villagemedia.ca/agriculture",
                obituaries: "https://staging-www2.villagemedia.ca/obituaries",
                politics: "https://staging-www2.villagemedia.ca/politics",
                weather: "https://staging-www2.villagemedia.ca/weather",
                crime: "https://staging-www2.villagemedia.ca/crime-cops-court"
            },
            categoryLinks: {
                sports: [
                    { text: "All Sports", url: "https://staging-www2.villagemedia.ca/sports" },
                    { text: "North Sask Sports", url: "https://staging-www2.villagemedia.ca/north/local-sports" },
                    { text: "Central Sask Sports", url: "https://staging-www2.villagemedia.ca/central/local-sports" },
                    { text: "Southwest Sask Sports", url: "https://staging-www2.villagemedia.ca/southwest/local-sports" }
                ],
                agriculture: [
                    { text: "All Agriculture", url: "https://staging-www2.villagemedia.ca/agriculture" },
                    { text: "North Sask Agriculture", url: "https://staging-www2.villagemedia.ca/north/agriculture" },
                    { text: "Central Sask Agriculture", url: "https://staging-www2.villagemedia.ca/central/agriculture" }
                ],
                obituaries: [
                    { text: "All Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries" },
                    { text: "Regina Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries/regina-obituaries" },
                    { text: "Saskatoon Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries/saskatoon-obituaries" },
                    { text: "Yorkton Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries/yorkton-obituaries" },
                    { text: "Assiniboia Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries/assiniboia-obituaries" },
                    { text: "Estevan Obituaries", url: "https://staging-www2.villagemedia.ca/obituaries/estevan-obituaries" }
                ],
                politics: [{ text: "All Politics", url: "https://staging-www2.villagemedia.ca/politics" }],
                weather: [{ text: "All Weather", url: "https://staging-www2.villagemedia.ca/weather" }],
                crime: [{ text: "All Crime & Safety", url: "https://staging-www2.villagemedia.ca/crime-cops-court" }],
                more: [
                    { text: "Business & Energy", url: "https://staging-www2.villagemedia.ca/business" },
                    { text: "Opinion", url: "https://staging-www2.villagemedia.ca/opinion" },
                    { text: "Gas Prices", url: "https://staging-www2.villagemedia.ca/gas-prices" },
                    { text: "Politics", url: "https://staging-www2.villagemedia.ca/politics" },
                    { text: "Local Arts", url: "https://staging-www2.villagemedia.ca/local-arts" },
                    { text: "Everybody Has a Story", url: "https://staging-www2.villagemedia.ca/everybody-has-a-story" },
                    { text: "Videos", url: "https://staging-www2.villagemedia.ca/video" }
                ]
            },
            communityLinks: {
                communities: [
                    { text: "All Communities", url: "https://staging-www2.villagemedia.ca/" },
                    { text: "Regina", url: "https://staging-www2.villagemedia.ca/regina-today" },
                    { text: "Saskatoon", url: "https://staging-www2.villagemedia.ca/saskatoon-today" },
                    { text: "Estevan", url: "https://staging-www2.villagemedia.ca/southeast/estevanmercury" },
                    { text: "Yorkton", url: "https://staging-www2.villagemedia.ca/central/yorktonthisweek" },
                    { text: "Kamsack", url: "https://staging-www2.villagemedia.ca/central/kamsacktimes" }
                ]
            }
        };

        const extIcon = `<svg class="external-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 13V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V4C3 3.44772 3.44772 3 4 3H11M21 3L11 13M21 3H15M21 3V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        const downArrow = `<svg class="desktop-down-arrow" style="width:15px; height:15px; margin-left:2px; flex-shrink:0;" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`;
        
        // Material Symbols icons (24x24 viewBox) - inline SVGs for best performance
        const iconLocation = `<svg class="category-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
        const iconSports = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M363-121q-47 5-113.5-2.5T148-148q-14-32-23.5-100T120-364l243 243Zm95-16L136-459q17-75 49.5-136.5T261-701q43-43 104.5-74.5T498-823l324 324q-16 74-47 136t-74 105q-45 44-107.5 75.5T458-137Zm-82-183 264-264-56-56-264 264 56 56Zm462-274L595-839q48-6 118 2t99 25q18 40 25 103.5t1 114.5Z"/></svg>`;
        const iconAgriculture = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M240-160q-83 0-141.5-58.5T40-360q0-83 58.5-141.5T240-560q83 0 141.5 58.5T440-360q0 83-58.5 141.5T240-160Zm0-140q-25 0-42.5-17.5T180-360q0-25 17.5-42.5T240-420q25 0 42.5 17.5T300-360q0 25-17.5 42.5T240-300Zm540 140q-58 0-99-41t-41-99q0-58 41-99t99-41q58 0 99 41t41 99q0 58-41 99t-99 41ZM160-600q-17 0-28.5-11.5T120-640q0-17 11.5-28.5T160-680h120q33 0 56.5 23.5T360-600H160Zm165 325q35-35 35-85t-35-85q-35-35-85-35t-85 35q-35 35-35 85t35 85q35 35 85 35t85-35Zm497.5 17.5Q840-275 840-300t-17.5-42.5Q805-360 780-360t-42.5 17.5Q720-325 720-300t17.5 42.5Q755-240 780-240t42.5-17.5ZM476-320h126q10-72 62.5-115T783-478q25 0 49.5 7t47.5 21v-190q0-33-23.5-56.5T800-720H548l-42-44 56-56-28-28-142 142 30 28 56-56 42 42v92q0 33-23.5 56.5T440-520h-22q30 33 45.5 74t15.5 86q0 10-.5 20t-2.5 20Z"/></svg>`;
        const iconObituaries = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M440-80q-100 0-170-70t-70-170v-80q71-1 134 29t106 81v-153q-86-14-143-80.5T240-680v-136q0-26 23-36.5t43 6.5l74 64 69-84q12-14 31-14t31 14l69 84 74-64q20-17 43-6.5t23 36.5v136q0 90-57 156.5T520-443v153q43-51 106-81t134-29v80q0 100-70 170T520-80h-80Z"/></svg>`;
        const iconPolitics = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M200-80q-33 0-56.5-23.5T120-160v-182l110-125 57 57-80 90h546l-78-88 57-57 108 123v182q0 33-23.5 56.5T760-80H200Zm224-304L285-525q-23-23-23-57t23-57l196-196q23-23 57-23t57 23l141 139q23 23 23.5 56.5T737-583L537-383q-23 23-56.5 22.5T424-384Zm256-256L538-780 340-582l142 140 198-198Z"/></svg>`;
        const iconWeather = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M440-760v-160h80v160h-80Zm266 110-55-55 112-115 56 57-113 113Zm54 210v-80h160v80H760ZM440-40v-160h80v160h-80ZM254-652 140-763l57-56 113 113-56 54Zm508 512L651-255l54-54 114 110-57 59ZM40-440v-80h160v80H40Zm157 300-56-57 112-112 29 27 29 28-114 114Zm113-170q-70-70-70-170t70-170q70-70 170-70t170 70q70 70 70 170t-70 170q-70 70-170 70t-170-70Z"/></svg>`;
        const iconCrime = `<svg class="category-icon" viewBox="0 -960 960 960" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="m368-336 112-84 110 84-42-136 112-88H524l-44-136-44 136H300l110 88-42 136ZM480-80q-139-35-229.5-159.5T160-516v-244l320-120 320 120v244q0 152-90.5 276.5T480-80Z"/></svg>`;
        const iconMore = `<svg class="category-icon more-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>`;

        const navHTML = `
        <div id="village-nav-container">
            <style>
                :root { --primary: #007bff; --nav-bg: #ffffff; --pill-bg: #f1f3f5; --text-inactive: #000000; --dropdown-glass: rgba(255, 255, 255, 0.75); --separator-color: #e9ecef; }
                #village-nav-container { background: var(--nav-bg); padding: 12px 0 0 0; width: 100%; position: relative; box-sizing: border-box; z-index: 1000; overflow: visible; }
                @media (min-width: 991px) {
                    #nav.show-below-new-nav { display: block !important; position: relative; top: 0; margin-top: 0; z-index: 999; width: 100%; }
                }
                .nav-content-wrapper { width: 990px; margin: 0 auto; position: relative; padding: 0 10px; display: flex; flex-direction: column; align-items: flex-start; z-index: 10; }
                @media (max-width: 990px) { .nav-content-wrapper { width: 100%; } }

                .top-row { display: flex !important; gap: 8px; align-items: center; width: 100%; position: relative; z-index: 11; margin-bottom: 8px; }
                .hide-scrollbar { overflow-x: auto; white-space: nowrap; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
                .hide-scrollbar::-webkit-scrollbar { display: none; }
                
                .category-pill, #comm-container { 
                    background: var(--pill-bg); border-radius: 20px; border: 2px solid transparent; 
                    font-weight: 600; font-size: 13px; padding: 6px 14px; cursor: pointer; transition: all 0.2s ease; 
                    display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; color: var(--text-inactive); position: relative;
                }
                .category-icon-wrapper { display: inline-flex; align-items: center; flex-shrink: 0; }
                .category-icon { width: 18px; height: 18px; display: block; }

                @media (min-width: 991px) {
                    .top-row { gap: 0px; padding-left: 0; overflow: visible; margin-bottom: 0; }
                    .category-pill, #comm-container { background: transparent !important; border: none !important; border-radius: 0; padding: 8px 12px; font-size: 14px; font-weight: 550; position: relative; cursor: default; }
                    .category-pill span, #comm-container span { cursor: pointer; }
                    #village-nav-container:not(:has(.bottom-row.active)) .category-pill.active, 
                    #village-nav-container:not(:has(.bottom-row.active)) #comm-container.active { padding-bottom: 10px; }
                    .top-row::after { content: ""; position: absolute; bottom: -2px; left: 0; width: 100%; height: 1px; background-color: var(--separator-color); z-index: 1; opacity: 0; }
                    #village-nav-container.mega-menu-open .top-row::after, #village-nav-container:has(.bottom-row.active) .top-row::after, #village-nav-container:has(.desktop-mega-menu.visible) .top-row::after { opacity: 1; }
                    .category-pill::after, #comm-container::after { content: ""; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background-color: var(--primary); transform: scaleX(0); transform-origin: center; z-index: 2; transition: transform 0.3s ease; border-radius: 2px 2px 0 0; }
                    .category-pill:hover::after, #comm-container:hover::after, .category-pill.hover-active::after, #comm-container.hover-active::after { transform: scaleX(1); }
                    .category-pill.active::after, #comm-container.active::after { transform: scaleX(1); background-color: var(--primary); z-index: 3; }
                    .top-row:hover .category-pill.active:not(:hover):not(.hover-active)::after, .top-row:hover #comm-container.active:not(:hover):not(.hover-active)::after { transform: scaleX(0); }
                    #village-nav-container.suppress-active-underline .category-pill.active::after, #village-nav-container.suppress-active-underline #comm-container.active::after { transform: scaleX(0); }
                    .category-pill.hover-active.active::after, #comm-container.hover-active.active::after { transform: scaleX(1); background-color: var(--primary); z-index: 3; }
                    .bottom-row { height: auto !important; }
                    .bottom-row-inner { padding-top: 5px; padding-bottom: 5px; padding-left: 12px; }
                    .external-icon { width: 10px !important; height: 10px !important; }
                    #category-sports .bottom-row-inner a[href*="sportscage.com"], #category-agriculture .bottom-row-inner a[href*="saskagtoday.com"] { display: none; }
                    #search-trigger { display: inline-flex !important; }
                    #search-trigger .search-icon { display: inline-flex; align-items: center; width: 18px; height: 18px; }
                    #search-trigger .search-icon svg { width: 100%; height: 100%; }
                    #search-trigger:hover .search-icon { color: var(--primary); }
                    .desktop-mega-menu.search-menu .desktop-mega-menu-inner { gap: 40px; }
                    .desktop-mega-menu-search { flex: 0 0 auto; display: flex; flex-direction: column; gap: 16px; align-items: flex-start; min-width: 300px; }
                    .desktop-mega-menu-search h3 { font-size: 14px; font-weight: 500; margin: 0 0 8px 0; color: var(--text-inactive); }
                    .desktop-mega-menu-search input { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
                    .desktop-mega-menu-search input:focus { outline: none; border-color: var(--primary); }
                    .desktop-mega-menu-trending { flex: 0 0 auto; display: flex; flex-direction: column; gap: 12px; align-items: flex-start; min-width: 300px; }
                    .desktop-mega-menu-trending h3 { font-size: 11px; font-weight: 500; margin: 0 0 12px 0; color: #999; width: 100%; text-transform: uppercase; }
                    .desktop-mega-menu-trending-items { display: flex; flex-direction: column; gap: 12px; width: 100%; }
                    .desktop-mega-menu-trending-items a { color: var(--text-inactive); text-decoration: none; font-size: 13px; font-weight: 500; line-height: 1.4; padding: 4px 0; transition: color 0.2s, opacity 0.3s ease-in-out; display: flex; align-items: center; gap: 10px; opacity: 0; }
                    .desktop-mega-menu-trending-items a.visible { opacity: 1; }
                    .desktop-mega-menu-trending-items a:hover { color: var(--primary); }
                    .trending-story-icon { width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
                    .trending-story-icon svg { width: 100%; height: 100%; }
                    .trending-story-title { flex: 1; }
                }

                @media (max-width: 990px) {
                    .top-row { padding-left: 10px; }
                    .category-pill.active, #comm-container.active { background: var(--primary) !important; color: white !important; }
                    .desktop-down-arrow { display: none !important; }
                }

                .desktop-mega-menu { position: relative; left: 0; right: 0; width: 100%; background: var(--nav-bg); max-height: 0; overflow: hidden; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 3px; }
                .desktop-mega-menu.visible { max-height: 400px; }
                .desktop-mega-menu.search-menu { z-index: 1001; }
                #village-nav-container:has(.desktop-mega-menu.search-menu.visible) .bottom-row.active { display: none !important; }
                .desktop-mega-menu-inner { display: flex; width: 990px; margin: 0 auto; padding: 30px 10px 30px 30px; gap: 80px; }
                .desktop-mega-menu-inner.communities-menu { gap: 80px; }
                .desktop-mega-menu-links { flex: 0 0 auto; display: flex; flex-direction: column; gap: 12px; align-items: flex-start; }
                .desktop-mega-menu-links.communities-split { flex: 0 0 auto; }
                .desktop-mega-menu-links h3 { font-size: 11px; font-weight: 500; margin: 0 0 12px 0; color: #999; width: 100%; text-transform: uppercase; }
                .desktop-mega-menu-links-items { display: flex; flex-direction: column; gap: 12px; width: 100%; }
                .desktop-mega-menu-links-items.multi-column { display: grid; grid-template-columns: repeat(2, 1fr); column-gap: 40px; }
                .desktop-mega-menu-links-items.multi-column.communities-columns { column-gap: 40px; }
                .desktop-mega-menu-links a { color: var(--text-inactive); text-decoration: none; font-size: 12px; font-weight: 500; padding: 4px 0; transition: color 0.2s; text-align: left; }
                .desktop-mega-menu-links a:hover { color: var(--primary); }
                .desktop-mega-menu-links.communities-split a { display: flex; align-items: center; gap: 8px; }
                .desktop-mega-menu-links a .community-icon { width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0; object-fit: cover; opacity: 0; transition: opacity 0.3s ease-in-out; background-color: #f1f3f5; }
                .desktop-mega-menu-links a .community-icon.loaded { opacity: 1; }
                .desktop-mega-menu-newsletters { flex: 0 0 auto; display: flex; flex-direction: column; gap: 12px; align-items: flex-start; }
                .desktop-mega-menu-newsletters.communities-split { flex: 0 0 auto; }
                .desktop-mega-menu-newsletters h3 { font-size: 11px; font-weight: 500; margin: 0 0 12px 0; color: #999; width: 100%; text-transform: uppercase; }
                .desktop-mega-menu-newsletters-items { display: flex; flex-direction: column; gap: 12px; width: 100%; }
                .desktop-mega-menu-newsletters-items.multi-column { display: grid; grid-template-columns: repeat(2, 1fr); column-gap: 40px; }
                .desktop-mega-menu-newsletters-items.multi-column.communities-columns { column-gap: 40px; }
                .desktop-mega-menu-newsletters a { color: var(--text-inactive); text-decoration: none; font-size: 12px; font-weight: 500; padding: 4px 0; transition: color 0.2s; text-align: left; }
                .desktop-mega-menu-newsletters a:hover { color: var(--primary); }
                .desktop-mega-menu-newsletters p { font-size: 13px; color: #666; margin: 0; }
                .desktop-mega-menu-brand { flex: 0 0 auto; display: flex; flex-direction: column; gap: 12px; align-items: flex-start; max-width: 200px; }
                .desktop-mega-menu-brand h3 { font-size: 11px; font-weight: 500; margin: 0 0 12px 0; color: #999; width: 100%; text-transform: uppercase; }
                .desktop-mega-menu-brand a { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 12px; width: 100%; cursor: pointer; transition: opacity 0.2s; }
                .desktop-mega-menu-brand a:hover { opacity: 0.7; }
                .desktop-mega-menu-brand-content { display: flex; flex-direction: column; gap: 12px; width: 100%; }
                .desktop-mega-menu-brand-content .brand-logo { width: 100px; height: auto; margin-bottom: 8px; opacity: 0; transition: opacity 0.3s ease-in-out; background-color: #f1f3f5; }
                .desktop-mega-menu-brand-content .brand-logo.loaded { opacity: 1; }
                .desktop-mega-menu-brand-content p { font-size: 12px; color: var(--text-inactive); margin: 0; line-height: 1.5; }
                @media (max-width: 990px) { .desktop-mega-menu { display: none !important; } }
                
                .bottom-row { display: none; height: 44px; width: 100%; opacity: 0; position: relative; }
                .bottom-row.active { display: flex; opacity: 1; }
                .bottom-row-inner { display: flex; align-items: center; gap: 20px; padding: 10px 0; width: 100%; }
                .text-link { color: var(--text-inactive); text-decoration: none; font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent; padding-bottom: 2px; }
                .text-link.active { color: var(--primary); font-weight: 700; border-bottom-color: var(--primary); }
                
                .external-icon { width: 14px !important; height: 14px !important; margin-left: 6px; flex-shrink: 0; display: inline-block; vertical-align: middle; }
                .dropdown-arrow-icon { width: 18px; height: 18px; fill: currentColor; display: none; }
                @media (max-width: 990px) { .dropdown-arrow-icon { display: block; } }
                #village-nav-dropdown-mobile { position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000001; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 200px; }
            </style>
            <div class="nav-content-wrapper">
                <div id="village-nav-dropdown-mobile" style="display: none;">
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 1px solid #eee;" data-community="all">All Communities</div>
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 1px solid #eee;" data-community="regina">Regina</div>
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 1px solid #eee;" data-community="saskatoon">Saskatoon</div>
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 1px solid #eee;" data-community="estevan">Estevan</div>
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 1px solid #eee;" data-community="yorkton">Yorkton</div>
                    <div class="dropdown-option" style="padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 600;" data-community="kamsack">Kamsack</div>
                </div>

                <div class="top-row hide-scrollbar" id="main-top-row">
                    <div id="comm-container" data-category="communities">
                        <span class="category-icon-wrapper">${iconLocation}</span><span id="community-label">Communities</span>
                        <svg class="dropdown-arrow-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                    </div>
                    <button class="category-pill" data-category="sports"><span class="category-icon-wrapper">${iconSports}</span><span>Sports</span></button>
                    <button class="category-pill" data-category="agriculture"><span class="category-icon-wrapper">${iconAgriculture}</span><span>Agriculture</span></button>
                    <button class="category-pill" data-category="obituaries"><span class="category-icon-wrapper">${iconObituaries}</span><span>Obituaries</span></button>
                    <button class="category-pill" data-category="politics"><span class="category-icon-wrapper">${iconPolitics}</span><span>Politics</span></button>
                    <button class="category-pill" data-category="weather"><span class="category-icon-wrapper">${iconWeather}</span><span>Weather</span></button>
                    <button class="category-pill" data-category="crime"><span class="category-icon-wrapper">${iconCrime}</span><span>Crime & Safety</span></button>
                    <button class="category-pill" id="mega-menu-trigger" data-category="more"><span class="category-icon-wrapper more-icon">${iconMore}</span><span>More</span></button>
                    <button class="category-pill search-trigger" id="search-trigger" type="button" style="display: none;"><span class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></span></button>
                </div>
                
                <div class="bottom-row" id="community-regina"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/regina-today" class="text-link">All Regina</a><a href="https://staging-www2.villagemedia.ca/regina-today/regina-news" class="text-link">Regina News</a><a href="https://staging-www2.villagemedia.ca/obituaries/regina-obituaries" class="text-link">Regina Obituaries</a><a href="https://staging-www2.villagemedia.ca/regina-today/regina-newsletters" class="text-link">Regina Newsletters</a><a href="https://staging-www2.villagemedia.ca/regina-today/regina-discussion" class="text-link">Regina Discussions</a><a href="https://staging-www2.villagemedia.ca/classifieds/regina-classifieds" class="text-link">Regina Classifieds</a></div></div>
                <div class="bottom-row" id="community-saskatoon"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/saskatoon-today" class="text-link">All Saskatoon</a><a href="https://staging-www2.villagemedia.ca/saskatoon-today/saskatoon-news" class="text-link">Saskatoon News</a><a href="https://staging-www2.villagemedia.ca/obituaries/saskatoon-obituaries" class="text-link">Saskatoon Obituaries</a><a href="https://staging-www2.villagemedia.ca/saskatoon-today/saskatoon-newsletters" class="text-link">Saskatoon Newsletters</a><a href="https://staging-www2.villagemedia.ca/saskatoon-today/saskatoon-discussion" class="text-link">Saskatoon Discussions</a><a href="https://staging-www2.villagemedia.ca/classifieds/saskatoon-classifieds" class="text-link">Saskatoon Classifieds</a></div></div>
                <div class="bottom-row" id="category-sports"><div class="bottom-row-inner hide-scrollbar"><a href="https://www.sportscage.com" target="_blank" class="text-link">Go to SportsCage ${extIcon}</a><a href="https://staging-www2.villagemedia.ca/sports" class="text-link">All Sports</a><a href="https://staging-www2.villagemedia.ca/north/local-sports" class="text-link">North Sask Sports</a><a href="https://staging-www2.villagemedia.ca/central/local-sports" class="text-link">Central Sask Sports</a><a href="https://staging-www2.villagemedia.ca/southwest/local-sports" class="text-link">Southwest Sask Sports</a></div></div>
                <div class="bottom-row" id="category-agriculture"><div class="bottom-row-inner hide-scrollbar"><a href="https://www.saskagtoday.com" target="_blank" class="text-link">Go to SaskAgToday ${extIcon}</a><a href="https://staging-www2.villagemedia.ca/agriculture" class="text-link">All Agriculture</a><a href="https://staging-www2.villagemedia.ca/north/agriculture" class="text-link">North Sask Agriculture</a><a href="https://staging-www2.villagemedia.ca/central/agriculture" class="text-link">Central Sask Agriculture</a></div></div>
                <div class="bottom-row" id="category-obituaries"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/obituaries" class="text-link">All Obituaries</a><a href="https://staging-www2.villagemedia.ca/obituaries/regina-obituaries" class="text-link">Regina Obituaries</a><a href="https://staging-www2.villagemedia.ca/obituaries/saskatoon-obituaries" class="text-link">Saskatoon Obituaries</a><a href="https://staging-www2.villagemedia.ca/obituaries/yorkton-obituaries" class="text-link">Yorkton Obituaries</a><a href="https://staging-www2.villagemedia.ca/obituaries/assiniboia-obituaries" class="text-link">Assiniboia Obituaries</a><a href="https://staging-www2.villagemedia.ca/obituaries/estevan-obituaries" class="text-link">Estevan Obituaries</a></div></div>
                <div class="bottom-row" id="category-politics"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/politics" class="text-link">All Politics</a></div></div>
                <div class="bottom-row" id="category-weather"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/weather" class="text-link">All Weather</a></div></div>
                <div class="bottom-row" id="category-crime"><div class="bottom-row-inner hide-scrollbar"><a href="https://staging-www2.villagemedia.ca/crime-cops-court" class="text-link">All Crime & Safety</a></div></div>
            </div>
        </div>`;

        const targetHeader = document.querySelector('header');
        if (targetHeader) {
            targetHeader.insertAdjacentHTML('beforeend', navHTML);
            initNavLogic();
            initHoverDropdowns();
            handleScrollLogic();
        }

        function handleScrollLogic() {
            const topRow = document.getElementById('main-top-row');
            if (window.innerWidth <= 990) { 
                topRow.scrollLeft = 0; 
            } else { 
                scrollActiveIntoView(topRow, '.category-pill.active, #comm-container.active'); 
            }

            const activeBottomInner = document.querySelector('.bottom-row.active .bottom-row-inner');
            const savedScroll = sessionStorage.getItem('nav_bottom_scroll');
            const lastCat = sessionStorage.getItem('nav_last_category');
            const url = window.location.href.split('?')[0].replace(/\/$/, "");
            
            let currentCat = 'home';
            for (let cat in routes.categories) { if (url.includes(cat)) currentCat = cat; }
            for (let comm in routes.communities) { if (url.includes(comm)) currentCat = comm; }

            if (activeBottomInner) {
                if (currentCat === lastCat && savedScroll) { 
                    activeBottomInner.scrollLeft = parseInt(savedScroll); 
                } else { 
                    scrollActiveIntoView(activeBottomInner, '.text-link.active'); 
                }
            }
            sessionStorage.setItem('nav_last_category', currentCat);
            const saveScroll = () => {
                const row = document.querySelector('.bottom-row.active .bottom-row-inner');
                if (row) sessionStorage.setItem('nav_bottom_scroll', row.scrollLeft);
            };
            document.querySelectorAll('.bottom-row-inner').forEach(r => r.addEventListener('scroll', saveScroll));
        }

        function scrollActiveIntoView(container, selector) {
            if (!container) return;
            const activeEl = container.querySelector(selector);
            if (activeEl) container.scrollLeft = activeEl.offsetLeft - (container.offsetWidth / 2) + (activeEl.offsetWidth / 2);
        }

        function initNavLogic() {
            const url = window.location.href.split('?')[0].replace(/\/$/, "");
            const topRow = document.getElementById('main-top-row'), commContainer = document.getElementById('comm-container');
            const container = document.getElementById('village-nav-container');
            let matched = false;

            // Parent Selection and Prepend for Mobile
            for (let cat in routes.categories) {
                if (url.includes(cat)) {
                    const pill = document.querySelector(`[data-category="${cat}"]`);
                    pill?.classList.add('active');
                    if (window.innerWidth <= 990 && pill) topRow.prepend(pill);
                    const bottomRow = document.getElementById(`category-${cat}`);
                    bottomRow?.classList.add('active');
                    if (bottomRow) container.classList.add('mega-menu-open');
                    matched = true; break;
                }
            }
            if (!matched) {
                for (let commKey in routes.communities) {
                    if (commKey !== 'all' && url.includes(commKey)) {
                        commContainer.classList.add('active');
                        if (window.innerWidth <= 990) topRow.prepend(commContainer);
                        document.getElementById('community-label').textContent = commKey.charAt(0).toUpperCase() + commKey.slice(1) + ', SK';
                        const bottomRow = document.getElementById(`community-${commKey}`);
                        bottomRow?.classList.add('active');
                        if (bottomRow) container.classList.add('mega-menu-open');
                        break;
                    }
                }
            }

            // Parent Click Handlers
            document.querySelectorAll('.category-pill:not(#mega-menu-trigger):not(#search-trigger)').forEach(pill => {
                pill.addEventListener('click', () => { window.location.href = routes.categories[pill.dataset.category]; });
            });

            // Community Mobile Dropdown logic
            commContainer.addEventListener('click', (e) => {
                if (window.innerWidth > 990) return;
                e.stopPropagation();
                const drop = document.getElementById('village-nav-dropdown-mobile');
                const rect = commContainer.getBoundingClientRect();
                const wrapperRect = document.querySelector('.nav-content-wrapper').getBoundingClientRect();
                drop.style.left = (rect.left - wrapperRect.left) + 'px';
                drop.style.display = (drop.style.display === 'block') ? 'none' : 'block';
            });

            document.querySelectorAll('.dropdown-option').forEach(opt => {
                opt.addEventListener('click', () => { window.location.href = routes.communities[opt.dataset.community]; });
            });

            // Child Active States
            document.querySelectorAll('.bottom-row.active .text-link').forEach(link => {
                if (url === link.href.replace(/\/$/, "")) link.classList.add('active');
            });

            const megaMenuTrigger = document.getElementById('mega-menu-trigger'), siteBurgButton = document.querySelector('.navbt-burg');
            if (megaMenuTrigger) {
                megaMenuTrigger.addEventListener('click', (e) => {
                    // Only handle click on mobile - desktop uses hover mega menu
                    if (window.innerWidth <= 990) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Mobile: use existing burger button behavior
                        if (siteBurgButton) {
                            siteBurgButton.click();
                        }
                    }
                });
            }
            
            // Search functionality
            try {
                const searchTrigger = document.getElementById('search-trigger');
                const container = document.getElementById('village-nav-container');
                let megaMenu = container ? container.querySelector('.desktop-mega-menu') : null;
                
                if (searchTrigger && window.innerWidth > 990) {
                searchTrigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // Remove any existing regular mega menu first
                    const regularMegaMenu = container.querySelector('.desktop-mega-menu:not(.search-menu)');
                    if (regularMegaMenu) {
                        regularMegaMenu.classList.remove('visible');
                    }
                    
                    // Check if megaMenu exists in the DOM, if not, reset the variable
                    if (megaMenu && container && !container.contains(megaMenu)) {
                        megaMenu = null;
                    }
                    
                    // Query for existing search menu in DOM, or create new one
                    megaMenu = container.querySelector('.desktop-mega-menu.search-menu');
                    
                    if (!megaMenu) {
                        megaMenu = document.createElement('div');
                        megaMenu.className = 'desktop-mega-menu search-menu';
                        if (container) container.appendChild(megaMenu);
                    }
                    
                    // Close any other active mega menus
                    document.querySelectorAll('.category-pill, #comm-container').forEach(p => {
                        p.classList.remove('hover-active');
                    });
                    
                    // Add hover-active class to search trigger to show underline
                    searchTrigger.classList.add('hover-active');
                    
                    // Build search menu
                    const inner = document.createElement('div');
                    inner.className = 'desktop-mega-menu-inner';
                    
                    // Left section - Search
                    const searchSection = document.createElement('div');
                    searchSection.className = 'desktop-mega-menu-search';
                    searchSection.innerHTML = `
                        <h3>What do you want to find?</h3>
                        <input type="text" id="search-input" placeholder="Search..." autofocus>
                    `;
                    inner.appendChild(searchSection);
                    
                    // Right section - Trending Stories
                    const trendingSection = document.createElement('div');
                    trendingSection.className = 'desktop-mega-menu-trending';
                    const trendingHeading = document.createElement('h3');
                    trendingHeading.textContent = 'Trending Stories';
                    trendingSection.appendChild(trendingHeading);
                    
                    const trendingItems = document.createElement('div');
                    trendingItems.className = 'desktop-mega-menu-trending-items';
                    
                    // Create 5 placeholder items to pre-allocate space and prevent height jump
                    for (let i = 0; i < 5; i++) {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'trending-story-item';
                        placeholder.style.opacity = '0.3';
                        placeholder.style.pointerEvents = 'none';
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'trending-story-icon';
                        iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#22c55e"><path d="m136-240-56-56 296-298 160 160 208-206H640v-80h240v240h-80v-104L536-320 376-480 136-240Z"/></svg>';
                        placeholder.appendChild(iconDiv);
                        
                        const titleSpan = document.createElement('span');
                        titleSpan.className = 'trending-story-title';
                        titleSpan.textContent = 'Loading...';
                        placeholder.appendChild(titleSpan);
                        
                        trendingItems.appendChild(placeholder);
                    }
                    
                    trendingSection.appendChild(trendingItems);
                    inner.appendChild(trendingSection);
                    
                    megaMenu.innerHTML = '';
                    megaMenu.classList.remove('search-menu');
                    megaMenu.classList.add('search-menu');
                    megaMenu.appendChild(inner);
                    megaMenu.classList.add('visible');
                    if (container) container.classList.add('mega-menu-open');
                    
                    // Ensure hover-active class is maintained on search trigger when menu is visible
                    searchTrigger.classList.add('hover-active');
                    
                    // Hide any active bottom-row when search menu is open
                    const activeBottomRow = document.querySelector('.bottom-row.active');
                    if (activeBottomRow) {
                        activeBottomRow.style.display = 'none';
                    }
                    
                    // Fetch trending stories
                    fetch('https://staging-www2.villagemedia.ca/rss/agriculture', { mode: 'cors' })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.text();
                        })
                        .then(str => {
                            const parser = new DOMParser();
                            const xml = parser.parseFromString(str, 'text/xml');
                            
                            // Check for parsing errors
                            const parseError = xml.querySelector('parsererror');
                            if (parseError) {
                                throw new Error('XML parsing error');
                            }
                            
                            const items = xml.querySelectorAll('item');
                            const trendingStories = [];
                            
                            for (let i = 0; i < Math.min(5, items.length); i++) {
                                const item = items[i];
                                const titleEl = item.querySelector('title');
                                const linkEl = item.querySelector('link');
                                const title = titleEl ? titleEl.textContent.trim() : '';
                                const link = linkEl ? linkEl.textContent.trim() : '';
                                if (title && link) {
                                    trendingStories.push({ title, link });
                                }
                            }
                            
                            // Replace placeholder items with actual stories
                            trendingItems.innerHTML = '';
                            if (trendingStories.length > 0) {
                                trendingStories.forEach((story, index) => {
                                    const a = document.createElement('a');
                                    a.href = story.link;
                                    a.className = 'trending-story-item';
                                    
                                    // Add trending icon
                                    const iconDiv = document.createElement('div');
                                    iconDiv.className = 'trending-story-icon';
                                    iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#22c55e"><path d="m136-240-56-56 296-298 160 160 208-206H640v-80h240v240h-80v-104L536-320 376-480 136-240Z"/></svg>';
                                    a.appendChild(iconDiv);
                                    
                                    const titleSpan = document.createElement('span');
                                    titleSpan.textContent = story.title;
                                    titleSpan.className = 'trending-story-title';
                                    a.appendChild(titleSpan);
                                    
                                    trendingItems.appendChild(a);
                                    
                                    // Cascading fade-in effect - each item fades in with a delay
                                    setTimeout(() => {
                                        a.classList.add('visible');
                                    }, index * 50); // 50ms delay between each item
                                });
                            } else {
                                trendingItems.innerHTML = '<div style="color: #999; font-size: 12px;">No trending stories available</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching trending stories:', error);
                            trendingItems.innerHTML = '<div style="color: #999; font-size: 12px;">Unable to load trending stories</div>';
                        });
                    
                    // Handle search input
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) {
                        searchInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const query = searchInput.value.trim();
                                if (query) {
                                    window.location.href = `https://www.sasktoday.ca/search?q=${encodeURIComponent(query)}`;
                                }
                            }
                        });
                    }
                    
                    // Close on click outside
                    setTimeout(() => {
                        const closeHandler = (e) => {
                            if (!megaMenu.contains(e.target) && !searchTrigger.contains(e.target)) {
                                megaMenu.classList.remove('visible');
                                if (container) container.classList.remove('mega-menu-open');
                                
                                // Restore bottom-row visibility when search menu is closed
                                const activeBottomRow = document.querySelector('.bottom-row.active');
                                if (activeBottomRow) {
                                    activeBottomRow.style.display = 'flex';
                                }
                                
                                document.removeEventListener('click', closeHandler);
                            }
                        };
                        document.addEventListener('click', closeHandler);
                    }, 100);
                });
            }
            
            document.addEventListener('click', () => { document.getElementById('village-nav-dropdown-mobile').style.display = 'none'; });
            } catch (error) {
                console.error('Error initializing search:', error);
            }
        }

        function initHoverDropdowns() {
            if (window.innerWidth <= 990) return;
            const pills = document.querySelectorAll('.category-pill:not(#search-trigger), #comm-container');
            const wrapper = document.querySelector('.nav-content-wrapper');
            const container = document.getElementById('village-nav-container');
            let hoverTimeout = null;
            let showTimeout = null; // Timeout for showing the mega menu
            let currentPill = null; // Track which pill is currently showing the mega menu
            let userHasInteracted = false;

            // Prevent mega menu from showing immediately on load until user moves mouse
            const enableInteractions = () => {
                userHasInteracted = true;
                document.removeEventListener('mousemove', enableInteractions);
            };
            document.addEventListener('mousemove', enableInteractions);

            // Create a single mega menu container - append to container for full width
            // First, remove any search menu element if it exists
            const existingSearchMenu = container.querySelector('.desktop-mega-menu.search-menu');
            if (existingSearchMenu) {
                existingSearchMenu.remove();
            }
            
            let megaMenu = container.querySelector('.desktop-mega-menu:not(.search-menu)');
            if (!megaMenu) {
                megaMenu = document.createElement('div');
                megaMenu.className = 'desktop-mega-menu';
                container.appendChild(megaMenu);
            }

        // Set up mega menu event listeners only once
        megaMenu.addEventListener('mouseenter', () => {
            clearTimeout(hoverTimeout);
            // Keep hover-active class when entering mega menu - only for the current pill
            // But don't add it if the current pill is the active one (it should stay hidden)
            if (currentPill && !currentPill.classList.contains('active')) {
                currentPill.classList.add('hover-active');
            }
        });
            megaMenu.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => { 
                    megaMenu.classList.remove('visible');
                    container.classList.remove('mega-menu-open');
                    if (currentPill) {
                        // Only remove hover-active if the pill is not active
                        if (!currentPill.classList.contains('active')) {
                            currentPill.classList.remove('hover-active');
                        }
                        currentPill = null;
                        container.classList.remove('suppress-active-underline');
                    }
                    // Restore bottom-row visibility when mega menu is hidden
                const activeBottomRow = document.querySelector('.bottom-row.active');
                if (activeBottomRow) {
                    activeBottomRow.style.display = 'flex';
                }
            }, 150);
        });

            pills.forEach(pill => {
                const cat = pill.dataset.category;
                const isCommunities = (cat === 'communities' || pill.id === 'comm-container');
                const links = isCommunities ? routes.communityLinks.communities : routes.categoryLinks[cat];
                if (!links) return;

                pill.insertAdjacentHTML('beforeend', downArrow);

            const show = () => {
                if (!userHasInteracted) return;
                clearTimeout(hoverTimeout);
                clearTimeout(showTimeout); // Clear any pending show timeout
                
                // Close search menu if open (it's a separate element)
                const searchMenuToClose = container.querySelector('.desktop-mega-menu.search-menu');
                if (searchMenuToClose) {
                    searchMenuToClose.classList.remove('visible');
                    searchMenuToClose.remove();
                    // Restore bottom-row visibility when search menu is closed
                    const activeBottomRow = document.querySelector('.bottom-row.active');
                    if (activeBottomRow) {
                        activeBottomRow.style.display = 'flex';
                    }
                }
                
                // Set current pill
                currentPill = pill;
                    
                    // If the current pill is NOT active, suppress the active underline on other items
                    if (!pill.classList.contains('active')) {
                        container.classList.add('suppress-active-underline');
                    } else {
                        container.classList.remove('suppress-active-underline');
                    }
                    
                    // Clear hover-active from all other pills
                    document.querySelectorAll('.category-pill, #comm-container').forEach(p => {
                        if (p !== pill) p.classList.remove('hover-active');
                    });
                    
                    // Add hover-active class to show underline
                    pill.classList.add('hover-active');
                    
                    // Hide the bottom-row when mega menu is visible
                    document.querySelectorAll('.bottom-row').forEach(row => {
                        row.style.display = 'none';
                    });
                    
                    // Calculate position to cover bottom-row area
                    const wrapperRect = wrapper.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    const topRow = wrapper.querySelector('.top-row');
                    const topRowRect = topRow ? topRow.getBoundingClientRect() : wrapperRect;
                    // Remove JavaScript positioning - not needed with relative positioning
                    
                    // Build the mega menu content
                    const inner = document.createElement('div');
                    inner.className = 'desktop-mega-menu-inner' + (isCommunities ? ' communities-menu' : '');
                    
                    if (isCommunities) {
                        // Special handling for Communities
                        const commContainer = document.getElementById('comm-container');
                        const isActive = commContainer && commContainer.classList.contains('active');
                        
                        // Find active community
                        let activeCommunityName = null;
                        let childLinks = [];
                        
                    if (isActive) {
                        const activeBottomRow = document.querySelector('.bottom-row.active[id^="community-"]');
                        
                        if (activeBottomRow) {
                            const commId = activeBottomRow.id.replace('community-', '');
                            // Find community name from routes by matching the ID (e.g., "regina" -> "Regina")
                            // Skip "All Communities" - we want the actual community
                            const commLink = routes.communityLinks.communities.find(c => 
                                c.text.toLowerCase() === commId.toLowerCase() && c.text !== 'All Communities'
                            );
                            
                            if (commLink) {
                                activeCommunityName = commLink.text;
                                // Get child links from the active bottom row
                                const childLinkElements = activeBottomRow.querySelectorAll('.text-link');
                                childLinks = Array.from(childLinkElements).map(link => {
                                    // Get text content, removing any SVG icons
                                    let text = link.textContent.trim();
                                    // Remove the external icon text if present
                                    text = text.replace(extIcon, '').trim();
                                    const hasIcon = link.querySelector('.external-icon') !== null;
                                    return {
                                        text: text,
                                        url: link.href,
                                        external: hasIcon || link.target === '_blank'
                                    };
                                });
                            }
                        }
                    }
                        
                        // Left section - Communities list
                        const communitiesSection = document.createElement('div');
                        communitiesSection.className = 'desktop-mega-menu-links communities-split';
                        const communitiesHeading = document.createElement('h3');
                        communitiesHeading.textContent = isActive ? 'Change Your Community' : 'Pick a Community';
                        communitiesSection.appendChild(communitiesHeading);
                        
                        const communitiesItems = document.createElement('div');
                        communitiesItems.className = 'desktop-mega-menu-links-items' + (links.length > 5 ? ' multi-column communities-columns' : '');
                        
                        links.forEach(link => {
                            const a = document.createElement('a');
                            a.href = link.url;
                            const icon = document.createElement('img');
                            icon.className = 'community-icon';
                            // Map community names to city image placeholders
                                const cityMap = {
                                    'All Communities': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=60&h=60&fit=crop&q=75',
                                    'Regina': 'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=60&h=60&fit=crop&q=75',
                                    'Saskatoon': 'https://images.unsplash.com/photo-1514924013411-cbf25faa35bb?w=60&h=60&fit=crop&q=75',
                                    'Estevan': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=60&h=60&fit=crop&q=75',
                                    'Yorkton': 'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=60&h=60&fit=crop&q=75',
                                    'Kamsack': 'https://images.unsplash.com/photo-1514924013411-cbf25faa35bb?w=60&h=60&fit=crop&q=75'
                                };
                                icon.src = cityMap[link.text] || 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=60&h=60&fit=crop&q=75';
                            icon.alt = link.text;
                            // Fade in image when loaded
                            icon.addEventListener('load', () => {
                                icon.classList.add('loaded');
                            });
                            // Handle case where image is already cached
                            if (icon.complete) {
                                icon.classList.add('loaded');
                            }
                            a.appendChild(icon);
                            if (link.external) {
                                a.target = '_blank';
                                const textSpan = document.createElement('span');
                                textSpan.textContent = link.text;
                                a.appendChild(textSpan);
                                const iconSvg = document.createElement('span');
                                iconSvg.innerHTML = extIcon;
                                a.appendChild(iconSvg);
                            } else {
                                const textNode = document.createTextNode(link.text);
                                a.appendChild(textNode);
                            }
                            communitiesItems.appendChild(a);
                        });
                        
                        communitiesSection.appendChild(communitiesItems);
                        inner.appendChild(communitiesSection);
                        
                        // Right section - Community sections (only if active)
                        if (isActive && activeCommunityName && childLinks.length > 0) {
                            const sectionsSection = document.createElement('div');
                            sectionsSection.className = 'desktop-mega-menu-newsletters communities-split';
                            const sectionsHeading = document.createElement('h3');
                            sectionsHeading.textContent = `${activeCommunityName} Sections`;
                            sectionsSection.appendChild(sectionsHeading);
                            
                            const sectionsItems = document.createElement('div');
                            sectionsItems.className = 'desktop-mega-menu-newsletters-items' + (childLinks.length > 5 ? ' multi-column communities-columns' : '');
                            
                            childLinks.forEach(link => {
                                const a = document.createElement('a');
                                a.href = link.url;
                                if (link.external) {
                                    a.target = '_blank';
                                    a.innerHTML = `${link.text} ${extIcon}`;
                                } else {
                                    a.textContent = link.text;
                                }
                                sectionsItems.appendChild(a);
                            });
                            
                            sectionsSection.appendChild(sectionsItems);
                            inner.appendChild(sectionsSection);
                        }
                    } else {
                        // Regular categories - 60/40 split with links and newsletter
                        // Left section - links (60%)
                        const linksSection = document.createElement('div');
                        linksSection.className = 'desktop-mega-menu-links';
                        const sectionsHeading = document.createElement('h3');
                        sectionsHeading.textContent = 'Sections';
                        linksSection.appendChild(sectionsHeading);
                        
                        const linksItems = document.createElement('div');
                        linksItems.className = 'desktop-mega-menu-links-items' + (links.length > 5 ? ' multi-column' : '');
                        
                        links.forEach(link => {
                            const a = document.createElement('a');
                            a.href = link.url;
                            if (link.external) {
                                a.target = '_blank';
                                a.innerHTML = `${link.text} ${extIcon}`;
                            } else {
                                a.textContent = link.text;
                            }
                            linksItems.appendChild(a);
                        });
                        
                        linksSection.appendChild(linksItems);
                        inner.appendChild(linksSection);
                        
                        // Middle section - brand promotion (Sports and Agriculture only)
                        if (cat === 'sports' || cat === 'agriculture') {
                            const brandSection = document.createElement('div');
                            brandSection.className = 'desktop-mega-menu-brand';
                            
                            if (cat === 'sports') {
                                brandSection.innerHTML = `
                                    <h3>SportsCage</h3>
                                    <a href="https://sportscage.com" target="_blank" class="desktop-mega-menu-brand-link">
                                        <div class="desktop-mega-menu-brand-content">
                                            <img src="https://www.vmcdn.ca/files/sportscage/images/logos/HMI-SPORTS-CAGE-RIDERS-green.svg" alt="SportsCage" class="brand-logo">
                                            <p>Our most comprehensive Sask sports coverage is available on SportsCage. Visit SportsCage ${extIcon}</p>
                                        </div>
                                    </a>
                                `;
                                // Fade in logo when loaded
                                const sportsLogo = brandSection.querySelector('.brand-logo');
                                if (sportsLogo) {
                                    sportsLogo.addEventListener('load', () => {
                                        sportsLogo.classList.add('loaded');
                                    });
                                    // Handle case where image is already cached
                                    if (sportsLogo.complete) {
                                        sportsLogo.classList.add('loaded');
                                    }
                                }
                            } else if (cat === 'agriculture') {
                                brandSection.innerHTML = `
                                    <h3>SaskAgToday</h3>
                                    <a href="https://saskagtoday.com" target="_blank" class="desktop-mega-menu-brand-link">
                                        <div class="desktop-mega-menu-brand-content">
                                            <img src="https://www.vmcdn.ca/files/ui/harvard/saskagtoday.svg" alt="SaskAgToday" class="brand-logo">
                                            <p>Our most comprehensive ag news, crop pricing, weather forecasts and more are available on SaskAgToday. Visit SaskAgToday ${extIcon}</p>
                                        </div>
                                    </a>
                                `;
                                // Fade in logo when loaded
                                const agLogo = brandSection.querySelector('.brand-logo');
                                if (agLogo) {
                                    agLogo.addEventListener('load', () => {
                                        agLogo.classList.add('loaded');
                                    });
                                    // Handle case where image is already cached
                                    if (agLogo.complete) {
                                        agLogo.classList.add('loaded');
                                    }
                                }
                            }
                            
                            inner.appendChild(brandSection);
                        }
                        
                        // Right section - newsletters placeholder
                        const newslettersSection = document.createElement('div');
                        newslettersSection.className = 'desktop-mega-menu-newsletters';
                        newslettersSection.innerHTML = '<h3>Newsletters</h3><p>Newsletter placeholder for this category</p>';
                        
                        inner.appendChild(newslettersSection);
                    }
                    
                    // Ensure search menu is closed and removed
                    const searchMenuToRemove = container.querySelector('.desktop-mega-menu.search-menu');
                    if (searchMenuToRemove) {
                        searchMenuToRemove.classList.remove('visible');
                        searchMenuToRemove.remove();
                    }
                    
                    // Clear and populate
                    megaMenu.innerHTML = '';
                    megaMenu.classList.remove('search-menu'); // Ensure regular mega menu doesn't have search-menu class
                    megaMenu.appendChild(inner);
                    megaMenu.classList.add('visible');
                    container.classList.add('mega-menu-open');
                };
                
                const hide = () => { 
                    clearTimeout(showTimeout); // Clear any pending show timeout
                    hoverTimeout = setTimeout(() => { 
                        megaMenu.classList.remove('visible');
                        container.classList.remove('mega-menu-open');
                        // Only remove hover-active if the pill is not active
                        if (!pill.classList.contains('active')) {
                            pill.classList.remove('hover-active');
                        }
                        if (currentPill === pill) {
                            currentPill = null;
                            container.classList.remove('suppress-active-underline');
                        }
                        // Restore bottom-row visibility when mega menu is hidden
                        const activeBottomRow = document.querySelector('.bottom-row.active');
                        if (activeBottomRow) {
                            activeBottomRow.style.display = 'flex';
                        }
                    }, 300); // 300ms delay - longer than show delay to prevent flicker when moving between parents
                };

            pill.addEventListener('mouseenter', () => {
                // Clear any existing show timeout and hide timeout
                clearTimeout(showTimeout);
                clearTimeout(hoverTimeout); // Clear hide timeout from previous parent
                
                // If we're moving between parent items (mega menu already visible), use short delay
                // Otherwise, use longer delay to prevent accidental activation
                const isMovingBetweenItems = currentPill !== null && megaMenu.classList.contains('visible');
                const delay = isMovingBetweenItems ? 50 : 250;
                
                showTimeout = setTimeout(() => {
                    show();
                }, delay);
            });
            
            pill.addEventListener('mouseleave', () => {
                // Clear the show timeout if user moves away before delay completes
                clearTimeout(showTimeout);
                hide();
            });
        });
        }
    });
    </script>
  </body>
</html>

